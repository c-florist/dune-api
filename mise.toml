[env]
_.file = ".env.secrets"
_.python.venv = { path = ".venv", create = true }

DB_PATH = "./dune.sqlite3"
# Used for dbmate migrations
DATABASE_URL = "sqlite3:{{env.DB_PATH}}"

[tools]
python = "3.13"
pre-commit = "4.3"
dbmate = "2.28"

[tasks.init]
description = "Initialise the development environment"
run = "uv sync && python -m scripts.seed_database"

[tasks.dev]
description = "Run the development server"
run = "uvicorn app.main:app --reload"

[tasks.build]
description = "Build the application container"
run = "docker build -t dune-api ."

[tasks.start]
description = "Start the application container"
run = "docker run -p 8080:8080 dune-api"

[tasks.init-tests]
description = "Initialise the test environment"
hide = true
run = "python -m tests.setup"
env = { DB_PATH = "./test.sqlite3", DATABASE_URL = "sqlite3:./test.sqlite3" }

[tasks.test]
description = "Run unit tests"
depends = ["init-tests"]
run = "python -m pytest tests -vvv"
env = { DB_PATH = "./test.sqlite3", DATABASE_URL = "sqlite3:./test.sqlite3" }

[tasks.format]
description = "Run the formatter [and modify files]"
run = "ruff format {{arg(name='dir', default='.')}}"

[tasks.lint]
description = "Run the linter [and modify files]"
run = "ruff check --fix {{arg(name='dir', default='.')}}"

[tasks.typecheck]
description = "Run the basedpyright type checker"
run = "basedpyright --level error {{arg(name='dir', default='.')}}"
